// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

/* Enums */

enum DocumentType {
  CC
  TI
  RC
  CE
  PA
}

enum Priority {
  urgente
  alta
  normal
  baja
}

enum AuthorizationStatus {
  pending
  scheduled
  completed
  expired
  cancelled
}

enum AppointmentStatus {
  scheduled
  confirmed
  completed
  cancelled
  no_show
}

enum OcrStatus {
  pending
  processing
  completed
  failed
}

enum NotificationType {
  expiration_warning
  appointment_reminder 
  ocr_completed
  ocr_failed
}

/* Models */

model User {
  id String @id @default(uuid()) @db.Uuid
  email String @unique @db.VarChar(255)
  passwordHash String @map("password_hash") @db.VarChar(255)
  fullname String @map("full_name") @db.VarChar(200)
  isActive Boolean @default(true) @map("is_active")
  emailNotifications Boolean @default(true) @map("email_notifications")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updateAt DateTime @updatedAt @map("updated_at") @db.Timestamptz

  familyMembers FamilyMember[]
  notifications Notification[]

  @@map("users")
}

model EpsProvider {
  id String @id @default(uuid()) @db.Uuid
  name String @db.VarChar(200)
  code String? @unique @db.VarChar(20)
  parserKey String @map("parser_key") @db.VarChar(50)
  logoUrl String? @map("logo_url")
  isActive Boolean @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz

  familyMembers FamilyMember[]
  authorizations Authorization[]

  @@map("eps_providers")
}

model FamilyMember {
  id              String        @id @default(uuid()) @db.Uuid
  userId          String        @map("user_id") @db.Uuid
  epsProviderId   String?       @map("eps_provider_id") @db.Uuid
  fullName        String        @map("full_name") @db.VarChar(200)
  documentType    DocumentType? @map("document_type")
  documentNumber  String?       @map("document_number") @db.VarChar(20)
  birthDate       DateTime?     @map("birth_date") @db.Date
  address         String?       @db.VarChar(300)
  phone           String?       @db.VarChar(20)
  cellphone       String?       @db.VarChar(20)
  email           String?       @db.VarChar(255)
  department      String?       @db.VarChar(100)
  city            String?       @db.VarChar(100)
  regime          String?       @db.VarChar(50)
  relationship    String?       @db.VarChar(50)
  createdAt       DateTime      @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime      @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  user           User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  epsProvider    EpsProvider?  @relation(fields: [epsProviderId], references: [id])
  authorizations Authorization[]
  appointments   Appointment[]

  @@map("family_members")
}

model Authorization {
  id              String  @id @default(uuid()) @db.Uuid
  familyMemberId  String  @map("family_member_id") @db.Uuid
  epsProviderId   String? @map("eps_provider_id") @db.Uuid

  // Identificación del documento
  documentType    String    @map("document_type") @db.VarChar(50)
  requestNumber   String?   @map("request_number") @db.VarChar(50)
  issuingDate     DateTime? @map("issuing_date") @db.Timestamptz
  expirationDate  DateTime? @map("expiration_date") @db.Date

  // Diagnóstico
  diagnosisCode        String? @map("diagnosis_code") @db.VarChar(20)
  diagnosisDescription String? @map("diagnosis_description")
  patientLocation      String? @map("patient_location") @db.VarChar(50)
  serviceOrigin        String? @map("service_origin") @db.VarChar(50)

  // Prestador / IPS asignada
  providerName       String? @map("provider_name") @db.VarChar(200)
  providerNit        String? @map("provider_nit") @db.VarChar(20)
  providerCode       String? @map("provider_code") @db.VarChar(20)
  providerAddress    String? @map("provider_address") @db.VarChar(300)
  providerPhone      String? @map("provider_phone") @db.VarChar(30)
  providerDepartment String? @map("provider_department") @db.VarChar(100)
  providerCity       String? @map("provider_city") @db.VarChar(100)

  // Pagos compartidos
  paymentType      String?  @map("payment_type") @db.VarChar(30)
  copayValue       Decimal  @default(0) @map("copay_value") @db.Decimal(12, 2)
  copayPercentage  Decimal? @map("copay_percentage") @db.Decimal(5, 2)
  maxValue         Decimal  @default(0) @map("max_value") @db.Decimal(12, 2)
  weeksContributed Int?     @map("weeks_contributed")

  // Metadatos del procesamiento
  priority         Priority            @default(normal)
  status           AuthorizationStatus @default(pending)
  originalFileUrl  String?             @map("original_file_url")
  ocrRawText       String?             @map("ocr_raw_text")
  ocrConfidence    Decimal?            @map("ocr_confidence") @db.Decimal(3, 2)
  ocrParserUsed    String?             @map("ocr_parser_used") @db.VarChar(50)
  manuallyReviewed Boolean             @default(false) @map("manually_reviewed")
  notes            String?

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  familyMember FamilyMember          @relation(fields: [familyMemberId], references: [id], onDelete: Cascade)
  epsProvider  EpsProvider?           @relation(fields: [epsProviderId], references: [id])
  services     AuthorizationService[]
  appointments Appointment[]
  documents    Document[]

  // Indexes
  @@index([expirationDate], map: "idx_authorizations_expiration")
  @@index([familyMemberId], map: "idx_authorizations_family_member")
  @@index([status], map: "idx_authorizations_status")

  @@map("authorizations")
}

model AuthorizationService {
  id              String   @id @default(uuid()) @db.Uuid
  authorizationId String   @map("authorization_id") @db.Uuid
  serviceCode     String   @map("service_code") @db.VarChar(20)
  quantity        Int      @default(1)
  serviceName     String   @map("service_name")
  serviceType     String?  @map("service_type") @db.VarChar(30)
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz

  authorization Authorization @relation(fields: [authorizationId], references: [id], onDelete: Cascade)
  appointments  Appointment[]

  @@map("authorization_services")
}

model Appointment {
  id                     String            @id @default(uuid()) @db.Uuid
  authorizationId        String?           @map("authorization_id") @db.Uuid
  authorizationServiceId String?           @map("authorization_service_id") @db.Uuid
  familyMemberId         String            @map("family_member_id") @db.Uuid
  appointmentDate        DateTime          @map("appointment_date") @db.Timestamptz
  location               String?           @db.VarChar(300)
  doctorName             String?           @map("doctor_name") @db.VarChar(200)
  specialty              String?           @db.VarChar(100)
  notes                  String?
  status                 AppointmentStatus @default(scheduled)
  reminderSent           Boolean           @default(false) @map("reminder_sent")
  createdAt              DateTime          @default(now()) @map("created_at") @db.Timestamptz
  updatedAt              DateTime          @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  authorization        Authorization?        @relation(fields: [authorizationId], references: [id])
  authorizationService AuthorizationService? @relation(fields: [authorizationServiceId], references: [id])
  familyMember         FamilyMember          @relation(fields: [familyMemberId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([appointmentDate], map: "idx_appointments_date")
  @@index([familyMemberId], map: "idx_appointments_family_member")

  @@map("appointments")
}

model Document {
  id              String    @id @default(uuid()) @db.Uuid
  authorizationId String    @map("authorization_id") @db.Uuid
  fileName        String?   @map("file_name") @db.VarChar(255)
  fileUrl         String    @map("file_url")
  fileType        String?   @map("file_type") @db.VarChar(10)
  fileSizeBytes   Int?      @map("file_size_bytes")
  ocrStatus       OcrStatus @default(pending) @map("ocr_status")
  ocrErrorMessage String?   @map("ocr_error_message")
  uploadedAt      DateTime  @default(now()) @map("uploaded_at") @db.Timestamptz

  authorization Authorization @relation(fields: [authorizationId], references: [id], onDelete: Cascade)

  @@map("documents")
}

model Notification {
  id                String            @id @default(uuid()) @db.Uuid
  userId            String            @map("user_id") @db.Uuid
  title             String?           @db.VarChar(200)
  message           String?
  type              NotificationType?
  relatedEntityType String?           @map("related_entity_type") @db.VarChar(30)
  relatedEntityId   String?           @map("related_entity_id") @db.Uuid
  read              Boolean           @default(false)
  sentAt            DateTime          @default(now()) @map("sent_at") @db.Timestamptz

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([userId], map: "idx_notifications_user_unread")

  @@map("notifications")
}